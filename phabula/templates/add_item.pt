<metal:main use-macro="load: default.pt">
<metal:body fill-slot="body">
<body>
<style>

body {
    margin: 0;
    padding: 0;
}
#add_block {
    margin: 60px auto;
    width: 800px;
}
.link-button {
    background: #8890FF;
    display: block;
    padding: 7px 7px;
    text-align: center;
    text-decoration: none;
    color: #fff;
    font-weight: bold;
    border-radius: 2px;
}

.link-button {
    font-family: inherit;
    font-size: 13px;
    font-weight: bold;
    color: #fff;
    padding: 6px;
    width: 100%;
    z-index: 1;
    background: #3A6EC2;
    display: block;
    box-sizing: border-box;
    border: 0px;
    border-radius: 3px;
    margin: auto;
}

.link-button:hover {
    background: #417CDA;
}
.link-button:active {
    background-color: #3A6EC2;
    -moz-box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    -webkit-box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    padding-top: 7px;
    padding-bottom: 5px;
}
.box-style {
    font-family: Arial, sans-serif;
    font-size: 13px;
    background: #A9A4B7;
    border-radius: 3px;
    -moz-box-shadow: 0 1px 2px rgba(0,0,0,0.5);
    -webkit-box-shadow: 0 1px 2px rgba(0,0,0,0.5);
    box-shadow: 0 1px 2px rgba(0,0,0,0.5);
    z-index: 1;
}
.info-box {
    padding: 13px;
    font-family: Arial, sans-serif;
    margin: 30px auto;
    width: 300px;
    background: #F6FFFD;
}
.empty-box {
    border-radius: 2px;
    background: #F2F2F2 no-repeat;
    border: 1px solid #D2D2D2;
    width: 21px;
    height: 21px;
    background-image: url(${router.get_path('images', 'plus-21px.png')});
}
.empty-box:active {
    background: #D2D2D2;
    background-position: 0px 1px;
}
</style>
<style>
@font-face {
    font-family: 'Open Sans';
    font-style: normal;
    font-weight: 300;
    src: local('Open Sans Light'), local('OpenSans-Light'),
        url(//fonts.gstatic.com/s/opensans//v13/DXI1ORHCpsQm3Vp6mXoaTegdm0LZdjqr5-oayXSOefg.woff2) format('woff2')
        url(//fonts.gstatic.com/s/opensans/v13/DXI1ORHCpsQm3Vp6mXoaTXhCUOGz7vYGh680lGh-uXM.woff) format('woff')
    ;
}
@font-face {
    font-family: 'Open Sans';
    font-style: normal;
    font-weight: 300;
    src: local('Open Sans Light'), local('OpenSans-Light'),
        url(//fonts.gstatic.com/s/opensans/v13/cJZKeOuBrn4kERxqtaUH3VtXRa8TVwTICgirnJhmVJw.woff2) format('woff2'),
        url(//fonts.gstatic.com/s/opensans/v13/cJZKeOuBrn4kERxqtaUH3T8E0i7KZn-EPnyo3HZu7kw.woff) format('woff')
    ;
}
</style>
<style>
.form-label {
    font-weight: bold;
    line-height: 14px;
}
.ctrl-row {
    margin: 0 0 15px;
}
.ctrl-con label {
    display: block;
}

.ctrl-con label span {
    vertical-align: middle;
}

.text-field {
    font-size: 14px; 
    padding: 3px;
    box-sizing: border-box;
    border-radius: 2px;
    background: #FFFFFF;
    display: inline-block;
    border: 1px solid #dcdbe1;
    min-width: 230px;
}

.text-field:hover, .ctrl-con:hover .multi-tagger .text-field {
    border: 1px solid #94899e;
    z-index: 900;
}
.text-field:focus, .ctrl-con:focus .multi-tagger input {
    border: 1px solid #25252b;
    z-index: 1000;
}
.basic-form button[type=submit], .basic-form button[type=button], .link-button {
    font-family: inherit;
    font-size: 13px;
    font-weight: bold;
    display: block;
    box-sizing: border-box;
    border: 0px;
    border-radius: 3px;
    padding: 6px;
    width: 100%;
}

.button-enabled {
    color: #fff;
    background: #3A6EC2;
}

.button-enabled:hover, .link-button:hover {
    background: #417CDA;
}

.button-disabled {
    color: #FFF;
    background: #417CDA;
}

.button-enabled:active, .link-button:active {
    background-color: #3A6EC2;
    -moz-box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    -webkit-box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
    margin-top: 8px;
}

.basic-form .pop-box {
    border: 1px solid #d2f2f2;
    border-radius: 3px;
    margin-bottom: 10px;
    min-height: 32px;
    padding: 5px;
    position: relative;
}

.basic-form-inner {
    padding: 5px;
}

.form-container {
    padding: 13px 13px 26px 13px;
}
.basic-form-header {
    background: transparent !important;
    padding: 10px;
}

.basic-form-outer {
    background: #F6FFFD;
    border-radius: 0 0 3px 3px;
}
.basic-form-header h3 {
    margin: 0;
    padding: 0;
    color: #FFFFFF;
    text-shadow:1px 1px 0 #737878;
}
.basic-form input[type=checkbox] {
    vertical-align: middle;
    margin: 0px;
}
.basic-form label {
    vertical-align: bottom;
    padding-bottom: 5px;
}
.basic-form textarea {
    resize: none;
}
</style>
<metal:head use-macro="load: site_head.pt"/>
<script src="${js_editor}"></script>
<script src="${mootools}"></script>
<div tal:condition="params['url'].get('c_req') is not None" class="box-style info-box warning">
    <h3>Cookies Required for authentication.</h3>
    <p>Please enable cookies in your browser to continue.</p>
    <a class="link-button" style="width: 150px;" href="${path}">Try Again!</a>
</div>
<div tal:condition="params['url'].get('tout') is not None" class="box-style info-box warning">
    <h3>Form timeout</h3>
    <p>Please submit form within <span tal:content="params['url']['tout'][0]"></span> seconds</p>
    <a class="link-button" style="width: 150px;" href="${path}">Try Again!</a>
</div>
<div id="add_block" tal:condition="params['url'].get('c_req') is None and params['url'].get('tout') is None">
<div class="basic-form box-style">
    <div class="basic-form-header">
        <h3 class="form-title" tal:content="form.title"></h3>
    </div>
    <div class="basic-form-outer" id="${form.id}_con" style="width:${form.width}"> 
    <div class="basic-form-inner">
        <div class="form-container">
            <div id="form_notify" tal:define="n form.notify" tal:condition="n" class="pop-box notify-box dialog">
                <div class="ibox-32px notify-32px"></div>
                <span tal:replace="structure: n"></span>
                <span class="ibox-16px close-16px close-notify-16px closer"></span>
            </div>
            <div id="form_info" tal:condition="form.info and not form.valid == False and not form.invalid_key and not form.no_cookie" class="pop-box info-box dialog">
               <div class="ibox-32px info-32px"></div>
               <tal:repeat tal:repeat="item form.info"><span tal:replace="structure: item"/></tal:repeat>
                <span class="ibox-16px close-16px close-info-16px closer"></span>
            </div>
        <!--! Form override -->

<form  id="${form.id}" name="${form.name}" method="${form.method}" action="${form.action}" tal:attributes="novalidate 'novalidate' if form.novalidate else None" enctype="${form.enctype}">
    <div id="form_inner">
        <div tal:define="field form.get_field('title')" class="ctrl-row" tal:attributes="class 'ctrl-row input-error' if field.valid is False else 'ctrl-row'; id field.name; style 'display:'+field.get_style('display')+';;' if hasattr(field, 'get_style') and field.get_style('display') else None"> 
            <div class="ctrl-con">
                <label tal:condition="field.label" class="form-label" tal:attributes="for field.id if field.id else False">
                    <span tal:content="field.label"></span><span style="color:#FF0000;float:right;" tal:condition="field.required and field.valid is False" tal:content="field.invalid_message"></span></label>
            <tal:render tal:content="structure: field.render()"/>
            <p class="note" tal:condition="field.note"><span tal:content="structure: field.note"></span></p>
            </div>
        </div>
        <div tal:define="field form.get_field('tags')" class="ctrl-row" tal:attributes="class 'ctrl-row input-error' if field.valid is False else 'ctrl-row'; id field.name; style 'display:'+field.get_style('display')+';;' if hasattr(field, 'get_style') and field.get_style('display') else None"> 
            <div class="ctrl-con">
                <label tal:condition="field.label" class="form-label" tal:attributes="for field.id if field.id else False">
                    <span style="padding-bottom:5px;" tal:content="field.label"></span><span style="color:#FF0000;float:right;" tal:condition="field.required and field.valid is False" tal:content="field.invalid_message"></span></label>
                <div id="multi_tag" style="display:block;min-width:190px;margin-top:-1px;" class="multi-tagger">
                    <tal:render tal:content="structure: field.render()"/>
                    <span style="margin-left:5px;display:inline-block;vertical-align:middle;background-image:url(${router.get_path('images', 'plus-21px.png')});" class="empty-box add-tag" href="#"></span><span
                     style="display:inline-block;vertical-align:middle;background-image:url(${router.get_path('images', 'minus-21px.png')});" class="empty-box remove-tag" href="#"></span>
                </div>
            <p class="note" tal:condition="field.note"><span tal:content="structure: field.note"></span></p>
            </div>
        </div>
        <div tal:define="field form.get_field('section')" class="ctrl-row" tal:attributes="class 'ctrl-row input-error' if field.valid is False else 'ctrl-row'; id field.name; style 'display:'+field.get_style('display')+';;' if hasattr(field, 'get_style') and field.get_style('display') else None"> 
            <div class="ctrl-con">
                <label tal:condition="field.label" class="form-label" tal:attributes="for field.id if field.id else False">
                    <span style="padding-bottom:5px;" tal:content="field.label"></span><span style="color:#FF0000;float:right;" tal:condition="field.required and field.valid is False" tal:content="field.invalid_message"></span></label>
                <div style="display:inline-block;min-width:190px;">
                   <tal:render tal:content="structure: field.render()"/>
                   <span id="add_section" style="margin:5px;display:inline-block;vertical-align:middle;background-image:url(${router.get_path('images', 'plus-21px.png')});" class="empty-box" href="#"></span>
                </div>
            <p class="note" tal:condition="field.note"><span tal:content="structure: field.note"></span></p>
            </div>
        </div>
        <div tal:define="field form.get_field('body')" class="ctrl-row" tal:attributes="class 'ctrl-row input-error' if field.valid is False else 'ctrl-row'; id field.name; style 'display:'+field.get_style('display')+';;' if hasattr(field, 'get_style') and field.get_style('display') else None"> 
            <div class="ctrl-con">
                <label tal:condition="field.label" class="form-label" tal:attributes="for field.id if field.id else False">
                    <span tal:content="field.label"></span><span style="color:#FF0000;float:right;" tal:condition="field.required and field.valid is False" tal:content="field.invalid_message"></span></label>
            <tal:render tal:content="structure: field.render()"/>
            <p class="note" tal:condition="field.note"><span tal:content="structure: field.note"></span></p>
            </div>
        </div>
        <!--!FORM FIELDS
        <div class="ctrl-row" tal:attributes="class 'ctrl-row input-error' if field.valid is False else 'ctrl-row'; id field.name; style 'display:'+field.get_style('display')+';;' if hasattr(field, 'get_style') and field.get_style('display') else None"> 
            <div class="ctrl-con">
                <label tal:condition="field.label" class="form-label" tal:attributes="for field.id if field.id else False">
                    <span style="float:left;" tal:content="field.label"></span><span></span><span style="color:#FF0000;float:right;" tal:condition="field.required and field.valid is False" tal:content="field.invalid_message"></span></label>
            <tal:render tal:content="structure: field.render()"/>
            <p class="note" tal:condition="field.note"><span tal:content="structure: field.note"></span></p>
            </div>
        </div>
        -->
        <tal:f_loop tal:repeat="field form.get_fields(types='hidden')" tal:content="structure: field.render()"></tal:f_loop>
    <div id="btn_main" class="btn-con contain">
        <tal:b_loop tal:repeat="button form.get_buttons()" tal:content="structure: button.render()"/>
    </div>
    </div>
    <script type="text/javascript">

    var injectAddTags = function(){
            var multiTag = $('multi_tag');
            var multiTagLast = $('multi_tag_last');
            var tagClone = multiTag.clone();
            tagClone.children[0].value = '';
            addTagListener(tagClone.children[1]);
            removeTagListener(tagClone.children[2]);
            tagClone.id = multiTag.id+'_last';

            if (multiTagLast){
                multiTagLast.id = '';
                tagClone.inject(multiTagLast, 'after');
            } else {
                tagClone.inject(multiTag, 'after');
            }
    };

    var removeTag = function(){
        var pid = this.parentNode.id;
        var tagList = document.getElementsByClassName('multi-tagger');
        if (pid == ''){
            this.parentNode.remove();
        } else if (pid == 'multi_tag_last') {
            if (tagList.length > 2){
                this.parentNode.previousElementSibling.id = pid;
            }
            this.parentNode.remove();
        } else if (pid == 'multi_tag'){
            if (tagList.length > 1){
                this.parentNode.nextElementSibling.remove();
            }
        }
    };
    
    var addTagListener = function(tag){
        tag.addEventListener('click', injectAddTags);
    };

    var removeTagListener = function(tag){
        tag.addEventListener('click', removeTag.bind(tag));
    };
    
    var addTags = document.getElementsByClassName('add-tag');
    var removeTags = document.getElementsByClassName('remove-tag');
        
    for (i = 0; i < addTags.length; i++){
        addTagListener(addTags[i]);
    }
    
    for (i=0; i < removeTags.length; i++){
        removeTagListener(removeTags[i]);
    }
    
    </script>
    <script type="text/javascript">
    var addSectionForm;
    var sectionBlk = document.getElementById('section');
    function createOverlay(){
        var overlay = document.createElement('div');
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.position = 'fixed';
        overlay.style.backgroundColor = '#FFF';
        overlay.style.opacity = 0.4;
        overlay.style.zIndex = 999;
        overlay.style.display = "none";
        overlay.setProperty('id', 'overlay');
        overlay.addEventListener('click', function(){
            var con = getContainer();
            if (con._waiting == false){
                document.getElementById('overlay').style.display = "none";
                document.getElementById('xhr_add_section').style.display = "none";
                if (con._invalid == true){
                    con._init = false;
                    con._invalid = false;
                    getForm();
                }
            }
        });
        document.body.insertBefore(overlay, document.getElementById('site_head'));
    }

    function setOverlay(){
        document.getElementById('overlay').style.display = "block";
    }


    function renderForm(){
        var caller = this;
        function checkStatus(){
            if (this.status != 200){
            } else {
                var json = JSON.parse(this.responseText);
                if (json['status']['valid'] === true){
                    document.getElementById('xhr_add_section').remove()
                    document.getElementById('overlay').style.display = "none";
                } else {
                    var con = getContainer();
                    con.innerHTML = json['body'];
                    con._invalid = true;
                    con._init = false;
                    con._waiting = false;
                    setupForm(caller);
                }
            }
        };

        function postForm(){
            var btn = this.getElementById('section_button');
            getContainer()._waiting = true;
            btn.disabled = true;
            btn.setAttribute('class', 'button-disabled');
            btn.innerHTML = 'Adding...';
            setTimeout(function(){
            r = new XMLHttpRequest();
            r.open('POST', this.getElement('form').getAttribute('action'), true)
            r.onload = checkStatus;
            r.send();}.bind(this), 60*600);

        };

        function setupForm(p){
            var con = getContainer();
            con.setPosition(p.getPosition());
            if(con._init === false){
                btn = con.getElementById('section_button');
                btn.addEventListener('click', postForm.bind(con));
                con._init = true;
            }
            con.style.display = 'block';
        }
        setOverlay();
        setupForm(this);
    }

    function getContainer(){
        var e = document.getElementById('xhr_add_section');
        if (e == null){
            e = document.createElement('div');
            e.style.zIndex = 1000;
            e.setProperty('id', 'xhr_add_section');
            e.style.position = 'absolute';
            e.style.width = '50% auto';
            e.style.display = "none"
            e._init = false;
            e._invalid = false;
            e._waiting = false;
            e.inject(document.getElementById('overlay'), 'before');
        }
        return e;
    }

    
    function loadForm(){
        if (this.status == 200){
            getContainer().innerHTML = this.responseText;
        }
    }
    
    function getForm(){
        var add_section = "${router.get_path('add_section')}";
        var r = new XMLHttpRequest();
        r.onload = loadForm;
        r.open('GET', add_section, true);
        r.send();
    }

    (function(){
        createOverlay();
        getForm();
        addSection = document.getElementById('add_section');
        addSection.addEventListener('click', renderForm.bind(addSection));
    })();

    </script>

    
</form>
<!--! Form Override -->
        <script type="text/javascript">
        CKEDITOR.replace('body_field');
        </script>
        </div>
    </div>
    </div>
</div>
</div>
<metal:head use-macro="load: site_footer.pt"/>
</body>
</metal:body>
</metal:main>
